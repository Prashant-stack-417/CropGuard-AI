import Box from "@mui/material/Box";
import Container from "@mui/material/Container";
import Typography from "@mui/material/Typography";
import Paper from "@mui/material/Paper";
import Button from "@mui/material/Button";
import Grid from "@mui/material/Grid";
import Stack from "@mui/material/Stack";
import LinearProgress from "@mui/material/LinearProgress";
import Chip from "@mui/material/Chip";
import CircularProgress from "@mui/material/CircularProgress";
import DownloadOutlined from "@mui/icons-material/DownloadOutlined";
import LocalFloristOutlined from "@mui/icons-material/LocalFloristOutlined";
import ScienceOutlined from "@mui/icons-material/ScienceOutlined";
import WarningAmberOutlined from "@mui/icons-material/WarningAmberOutlined";
import VerifiedOutlined from "@mui/icons-material/VerifiedOutlined";

const Results = ({ result, isLoading }) => {
  if (!result && !isLoading) return null;

  const getConfidenceColor = (c) => {
    if (c >= 80) return "#5a9a3c";
    if (c >= 60) return "#d4953a";
    return "#c25a4a";
  };

  const severityColors = {
    None: { bg: "#eaf5ea", color: "#3a7a3a" },
    Low: { bg: "#eaf5ea", color: "#5a9a3c" },
    Medium: { bg: "#fdf5e6", color: "#9b7d4a" },
    High: { bg: "#fde0db", color: "#c25a4a" },
    Unknown: { bg: "#f0f0f0", color: "#666" },
  };

  const handleDownload = () => {
    if (!result) return;
    const lines = [
      "═══════════════════════════════════════════",
      "        CROPGUARD — DETECTION REPORT",
      "═══════════════════════════════════════════",
      "",
      `Date:        ${new Date().toLocaleString()}`,
      `Status:      ${result.status}`,
      `Crop:        ${result.crop_name}`,
      `Disease:     ${result.disease_name}`,
      `Confidence:  ${result.confidence}%`,
      `Severity:    ${result.severity}`,
      `Spread Risk: ${result.spread_risk}`,
      "",
      "DESCRIPTION",
      "───────────────────────────────────────────",
      result.description,
      "",
      "ORGANIC TREATMENT",
      "───────────────────────────────────────────",
      ...(result.organic_treatment?.map((t, i) => `  ${i + 1}. ${t}`) || []),
      "",
      "CHEMICAL TREATMENT",
      "───────────────────────────────────────────",
      ...(result.chemical_treatment?.map((t, i) => `  ${i + 1}. ${t}`) || []),
      "",
      "DOSAGE PER ACRE",
      "───────────────────────────────────────────",
      result.dosage || "Not applicable",
      "",
      "PREVENTION",
      "───────────────────────────────────────────",
      ...(result.prevention?.map((p, i) => `  ${i + 1}. ${p}`) || []),
      "",
      "  Generated by CropGuard",
    ];
    const blob = new Blob([lines.join("\n")], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `CropGuard_Report_${result.disease_name?.replace(/\s+/g, "_")}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  };

  return (
    <Box sx={{ py: { xs: 8, sm: 12 }, bgcolor: "#fafaf7" }}>
      <Container maxWidth="lg">
        <Stack spacing={5} alignItems="center">
          <Typography
            variant="h2"
            textAlign="center"
            className="animate-fade-in-up"
            sx={{ fontSize: { xs: "1.8rem", sm: "2.2rem" } }}
          >
            Detection Results
          </Typography>

          {isLoading ? (
            <Paper
              elevation={0}
              className="animate-scale-in"
              sx={{ p: 6, textAlign: "center", width: "100%", maxWidth: 460, border: "1px solid rgba(0,0,0,0.06)" }}
            >
              <CircularProgress size={56} thickness={3} sx={{ color: "#4a7c59", mb: 3 }} />
              <Typography variant="h6" fontWeight={600} gutterBottom>Looking at your photo...</Typography>
              <Typography color="text.secondary" variant="body2">Hang tight — we're checking the leaf for signs of disease</Typography>
            </Paper>
          ) : (
            <Paper
              elevation={0}
              className="animate-fade-in-up"
              sx={{ width: "100%", maxWidth: 900, overflow: "hidden", border: "1px solid rgba(0,0,0,0.08)" }}
            >
              {/* Header */}
              <Box sx={{ bgcolor: result.status === "Healthy" ? "#eaf5ea" : "#fdf0ee", borderBottom: "1px solid rgba(0,0,0,0.06)", p: 3 }}>
                <Stack direction="row" justifyContent="space-between" alignItems="center">
                  <Typography variant="h6" fontWeight={700}>Analysis Complete</Typography>
                  <Chip
                    label={result.status}
                    icon={result.status === "Healthy" ? <VerifiedOutlined sx={{ fontSize: 16 }} /> : <WarningAmberOutlined sx={{ fontSize: 16 }} />}
                    sx={{
                      fontWeight: 600,
                      bgcolor: result.status === "Healthy" ? "#d7ecd7" : "#fde0db",
                      color: result.status === "Healthy" ? "#3a7a3a" : "#b04030",
                      "& .MuiChip-icon": { color: "inherit" },
                    }}
                  />
                </Stack>
              </Box>

              {/* Body */}
              <Box sx={{ p: { xs: 3, sm: 4 } }}>
                <Grid container spacing={3}>
                  {/* Disease + Crop */}
                  <Grid item xs={12} sm={6}>
                    <Typography variant="overline" color="text.secondary" fontWeight={600}>Disease</Typography>
                    <Typography variant="h5" fontWeight={700} sx={{ mt: 0.5 }}>{result.disease_name}</Typography>
                  </Grid>
                  <Grid item xs={12} sm={6}>
                    <Typography variant="overline" color="text.secondary" fontWeight={600}>Crop</Typography>
                    <Typography variant="h5" fontWeight={700} sx={{ mt: 0.5 }}>{result.crop_name}</Typography>
                  </Grid>

                  {/* Severity + Spread chips */}
                  <Grid item xs={12}>
                    <Stack direction="row" spacing={1.5} flexWrap="wrap" useFlexGap>
                      {result.severity && result.severity !== "None" && (
                        <Chip label={`Severity: ${result.severity}`} size="small" sx={{ bgcolor: (severityColors[result.severity] || severityColors.Unknown).bg, color: (severityColors[result.severity] || severityColors.Unknown).color, fontWeight: 600 }} />
                      )}
                      {result.spread_risk && result.spread_risk !== "None" && (
                        <Chip label={`Spread Risk: ${result.spread_risk}`} size="small" sx={{ bgcolor: (severityColors[result.spread_risk] || severityColors.Unknown).bg, color: (severityColors[result.spread_risk] || severityColors.Unknown).color, fontWeight: 600 }} />
                      )}
                    </Stack>
                  </Grid>

                  {/* Confidence */}
                  <Grid item xs={12}>
                    <Stack spacing={1}>
                      <Stack direction="row" justifyContent="space-between" alignItems="center">
                        <Typography variant="overline" color="text.secondary" fontWeight={600}>Confidence</Typography>
                        <Typography variant="h6" fontWeight={700} sx={{ color: getConfidenceColor(result.confidence) }}>{result.confidence}%</Typography>
                      </Stack>
                      <LinearProgress
                        variant="determinate"
                        value={result.confidence}
                        sx={{
                          height: 8, borderRadius: 4, bgcolor: "rgba(0,0,0,0.05)",
                          "& .MuiLinearProgress-bar": { borderRadius: 4, bgcolor: getConfidenceColor(result.confidence) },
                        }}
                      />
                    </Stack>
                  </Grid>

                  {/* Description */}
                  <Grid item xs={12}>
                    <Typography variant="overline" color="text.secondary" fontWeight={600} sx={{ display: "block", mb: 1 }}>What we found</Typography>
                    <Paper elevation={0} sx={{ p: 2.5, bgcolor: "#f5f7f3", borderLeft: "3px solid #4a7c59", borderRadius: 1 }}>
                      <Typography color="text.primary" lineHeight={1.7} variant="body2">{result.description}</Typography>
                    </Paper>
                  </Grid>

                  {/* Organic Treatment */}
                  {result.organic_treatment?.length > 0 && (
                    <Grid item xs={12} md={6}>
                      <Stack direction="row" spacing={1} alignItems="center" sx={{ mb: 1.5 }}>
                        <LocalFloristOutlined sx={{ color: "#5a9a3c", fontSize: 20 }} />
                        <Typography variant="overline" fontWeight={700} sx={{ color: "#5a9a3c" }}>Organic Treatment</Typography>
                      </Stack>
                      <Stack spacing={1}>
                        {result.organic_treatment.map((t, i) => (
                          <Box key={i} sx={{ p: 2, bgcolor: "#f5f7f3", borderRadius: 2, border: "1px solid rgba(0,0,0,0.04)", display: "flex", gap: 1.5, alignItems: "flex-start" }}>
                            <Box sx={{ width: 24, height: 24, bgcolor: "#eaf5ea", color: "#5a9a3c", borderRadius: "50%", display: "flex", alignItems: "center", justifyContent: "center", fontWeight: 700, fontSize: "0.75rem", flexShrink: 0, mt: 0.25 }}>{i + 1}</Box>
                            <Typography variant="body2" sx={{ flex: 1, lineHeight: 1.6 }}>{t}</Typography>
                          </Box>
                        ))}
                      </Stack>
                    </Grid>
                  )}

                  {/* Chemical Treatment */}
                  {result.chemical_treatment?.length > 0 && (
                    <Grid item xs={12} md={6}>
                      <Stack direction="row" spacing={1} alignItems="center" sx={{ mb: 1.5 }}>
                        <ScienceOutlined sx={{ color: "#6d84a0", fontSize: 20 }} />
                        <Typography variant="overline" fontWeight={700} sx={{ color: "#6d84a0" }}>Chemical Treatment</Typography>
                      </Stack>
                      <Stack spacing={1}>
                        {result.chemical_treatment.map((t, i) => (
                          <Box key={i} sx={{ p: 2, bgcolor: "#f0f3f7", borderRadius: 2, border: "1px solid rgba(0,0,0,0.04)", display: "flex", gap: 1.5, alignItems: "flex-start" }}>
                            <Box sx={{ width: 24, height: 24, bgcolor: "#ecf0f5", color: "#6d84a0", borderRadius: "50%", display: "flex", alignItems: "center", justifyContent: "center", fontWeight: 700, fontSize: "0.75rem", flexShrink: 0, mt: 0.25 }}>{i + 1}</Box>
                            <Typography variant="body2" sx={{ flex: 1, lineHeight: 1.6 }}>{t}</Typography>
                          </Box>
                        ))}
                      </Stack>
                    </Grid>
                  )}

                  {/* Dosage */}
                  {result.dosage && (
                    <Grid item xs={12}>
                      <Paper elevation={0} sx={{ p: 2.5, bgcolor: "#f8f3ea", border: "1px solid rgba(155,125,74,0.12)", borderRadius: 2 }}>
                        <Typography variant="overline" color="text.secondary" fontWeight={600}>Dosage per Acre</Typography>
                        <Typography variant="body2" sx={{ mt: 0.5 }} lineHeight={1.7}>{result.dosage}</Typography>
                      </Paper>
                    </Grid>
                  )}

                  {/* Prevention */}
                  {result.prevention?.length > 0 && (
                    <Grid item xs={12}>
                      <Typography variant="overline" color="text.secondary" fontWeight={600} sx={{ display: "block", mb: 1.5 }}>How to prevent it</Typography>
                      <Stack spacing={1}>
                        {result.prevention.map((tip, i) => (
                          <Box key={i} sx={{ p: 2, bgcolor: "#fafaf7", borderRadius: 2, border: "1px solid rgba(0,0,0,0.04)", display: "flex", gap: 1.5, alignItems: "center" }}>
                            <Box sx={{ width: 24, height: 24, bgcolor: "#eaf5ea", color: "#4a7c59", borderRadius: "50%", display: "flex", alignItems: "center", justifyContent: "center", fontWeight: 700, fontSize: "0.75rem", flexShrink: 0 }}>{i + 1}</Box>
                            <Typography variant="body2" sx={{ flex: 1 }}>{tip}</Typography>
                          </Box>
                        ))}
                      </Stack>
                    </Grid>
                  )}

                  {/* Download */}
                  <Grid item xs={12}>
                    <Button variant="contained" size="large" startIcon={<DownloadOutlined />} fullWidth onClick={handleDownload} sx={{ mt: 1 }}>
                      Download Report
                    </Button>
                  </Grid>
                </Grid>
              </Box>
            </Paper>
          )}
        </Stack>
      </Container>
    </Box>
  );
};

export default Results;
