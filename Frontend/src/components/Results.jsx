import Box from "@mui/material/Box";
import Container from "@mui/material/Container";
import Typography from "@mui/material/Typography";
import Paper from "@mui/material/Paper";
import Button from "@mui/material/Button";
import Grid from "@mui/material/Grid";
import Stack from "@mui/material/Stack";
import LinearProgress from "@mui/material/LinearProgress";
import Chip from "@mui/material/Chip";
import CircularProgress from "@mui/material/CircularProgress";
import DownloadOutlined from "@mui/icons-material/DownloadOutlined";
import SupportAgentOutlined from "@mui/icons-material/SupportAgentOutlined";
import WarningAmberOutlined from "@mui/icons-material/WarningAmberOutlined";
import VerifiedOutlined from "@mui/icons-material/VerifiedOutlined";

const Results = ({ result, isLoading }) => {
  if (!result && !isLoading) return null;

  const getConfidenceColor = (c) => {
    if (c >= 80) return "#5a9a3c";
    if (c >= 60) return "#d4953a";
    return "#c25a4a";
  };

  const handleDownload = () => {
    if (!result) return;
    const lines = [
      "═══════════════════════════════════════════",
      "        CROPGUARD — DETECTION REPORT",
      "═══════════════════════════════════════════",
      "",
      `Date:        ${new Date().toLocaleString()}`,
      `Status:      ${result.status}`,
      `Disease:     ${result.diseaseName}`,
      `Crop:        ${result.cropName}`,
      `Confidence:  ${result.confidence}%`,
      `Severity:    ${result.severity}`,
      `Spread Risk: ${result.spreadRisk}`,
      "",
      "DESCRIPTION",
      "───────────────────────────────────────────",
      result.description,
      "",
      "TREATMENTS",
      "───────────────────────────────────────────",
      ...result.treatments.map((t, i) => `  ${i + 1}. ${t}`),
      "",
      "PREVENTION",
      "───────────────────────────────────────────",
      ...result.prevention.map((p, i) => `  ${i + 1}. ${p}`),
      "",
      "  Generated by CropGuard",
    ];
    const blob = new Blob([lines.join("\n")], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `CropGuard_Report_${result.diseaseName.replace(/\s+/g, "_")}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  };

  return (
    <Box sx={{ py: { xs: 8, sm: 12 }, bgcolor: "#fafaf7" }}>
      <Container maxWidth="lg">
        <Stack spacing={5} alignItems="center">
          <Typography
            variant="h2"
            textAlign="center"
            className="animate-fade-in-up"
            sx={{ fontSize: { xs: "1.8rem", sm: "2.2rem" } }}
          >
            Detection Results
          </Typography>

          {isLoading ? (
            <Paper
              elevation={0}
              className="animate-scale-in"
              sx={{
                p: 6,
                textAlign: "center",
                width: "100%",
                maxWidth: 460,
                border: "1px solid rgba(0,0,0,0.06)",
              }}
            >
              <CircularProgress size={56} thickness={3} sx={{ color: "#4a7c59", mb: 3 }} />
              <Typography variant="h6" fontWeight={600} gutterBottom>
                Looking at your photo...
              </Typography>
              <Typography color="text.secondary" variant="body2">
                Hang tight — we're checking the leaf for signs of disease
              </Typography>
            </Paper>
          ) : (
            <Paper
              elevation={0}
              className="animate-fade-in-up"
              sx={{
                width: "100%",
                maxWidth: 800,
                overflow: "hidden",
                border: "1px solid rgba(0,0,0,0.08)",
              }}
            >
              {/* Header */}
              <Box
                sx={{
                  bgcolor: result.status === "Healthy" ? "#eaf5ea" : "#fdf0ee",
                  borderBottom: "1px solid rgba(0,0,0,0.06)",
                  p: 3,
                }}
              >
                <Stack direction="row" justifyContent="space-between" alignItems="center">
                  <Typography variant="h6" fontWeight={700} color="text.primary">
                    Analysis Complete
                  </Typography>
                  <Chip
                    label={result.status}
                    icon={
                      result.status === "Healthy"
                        ? <VerifiedOutlined sx={{ fontSize: 16 }} />
                        : <WarningAmberOutlined sx={{ fontSize: 16 }} />
                    }
                    sx={{
                      fontWeight: 600,
                      bgcolor: result.status === "Healthy" ? "#d7ecd7" : "#fde0db",
                      color: result.status === "Healthy" ? "#3a7a3a" : "#b04030",
                      "& .MuiChip-icon": { color: "inherit" },
                    }}
                  />
                </Stack>
              </Box>

              {/* Body */}
              <Box sx={{ p: { xs: 3, sm: 4 } }}>
                <Grid container spacing={3}>
                  <Grid item xs={12} sm={6}>
                    <Typography variant="overline" color="text.secondary" fontWeight={600}>
                      Disease
                    </Typography>
                    <Typography variant="h5" fontWeight={700} sx={{ mt: 0.5 }}>
                      {result.diseaseName}
                    </Typography>
                  </Grid>

                  <Grid item xs={12} sm={6}>
                    <Typography variant="overline" color="text.secondary" fontWeight={600}>
                      Crop
                    </Typography>
                    <Typography variant="h5" fontWeight={700} sx={{ mt: 0.5 }}>
                      {result.cropName}
                    </Typography>
                  </Grid>

                  {/* Severity + Spread */}
                  <Grid item xs={12}>
                    <Stack direction="row" spacing={1.5} flexWrap="wrap" useFlexGap>
                      <Chip
                        label={`Severity: ${result.severity}`}
                        size="small"
                        sx={{
                          bgcolor: "rgba(74, 124, 89, 0.08)",
                          color: "#4a7c59",
                          fontWeight: 600,
                        }}
                      />
                      <Chip
                        label={`Spread Risk: ${result.spreadRisk}`}
                        size="small"
                        sx={{
                          bgcolor: "rgba(74, 124, 89, 0.08)",
                          color: "#4a7c59",
                          fontWeight: 600,
                        }}
                      />
                    </Stack>
                  </Grid>

                  {/* Confidence */}
                  <Grid item xs={12}>
                    <Stack spacing={1}>
                      <Stack direction="row" justifyContent="space-between" alignItems="center">
                        <Typography variant="overline" color="text.secondary" fontWeight={600}>
                          Confidence
                        </Typography>
                        <Typography variant="h6" fontWeight={700} sx={{ color: getConfidenceColor(result.confidence) }}>
                          {result.confidence}%
                        </Typography>
                      </Stack>
                      <LinearProgress
                        variant="determinate"
                        value={result.confidence}
                        sx={{
                          height: 8,
                          borderRadius: 4,
                          bgcolor: "rgba(0,0,0,0.05)",
                          "& .MuiLinearProgress-bar": {
                            borderRadius: 4,
                            bgcolor: getConfidenceColor(result.confidence),
                          },
                        }}
                      />
                    </Stack>
                  </Grid>

                  {/* Description */}
                  <Grid item xs={12}>
                    <Typography variant="overline" color="text.secondary" fontWeight={600} sx={{ display: "block", mb: 1 }}>
                      What we found
                    </Typography>
                    <Paper
                      elevation={0}
                      sx={{
                        p: 2.5,
                        bgcolor: "#f5f7f3",
                        borderLeft: "3px solid #4a7c59",
                        borderRadius: 1,
                      }}
                    >
                      <Typography color="text.primary" lineHeight={1.7} variant="body2">
                        {result.description}
                      </Typography>
                    </Paper>
                  </Grid>

                  {/* Treatments */}
                  <Grid item xs={12}>
                    <Typography variant="overline" color="text.secondary" fontWeight={600} sx={{ display: "block", mb: 1.5 }}>
                      What you can do
                    </Typography>
                    <Stack spacing={1.5}>
                      {result.treatments.map((treatment, index) => (
                        <Box
                          key={index}
                          sx={{
                            p: 2,
                            bgcolor: "#f5f7f3",
                            borderRadius: 2,
                            border: "1px solid rgba(0,0,0,0.04)",
                            display: "flex",
                            gap: 2,
                            alignItems: "center",
                          }}
                        >
                          <Box
                            sx={{
                              width: 28,
                              height: 28,
                              bgcolor: "#4a7c59",
                              color: "#fff",
                              borderRadius: "50%",
                              display: "flex",
                              alignItems: "center",
                              justifyContent: "center",
                              fontWeight: 700,
                              fontSize: "0.8rem",
                              flexShrink: 0,
                            }}
                          >
                            {index + 1}
                          </Box>
                          <Typography variant="body2" color="text.primary" sx={{ flex: 1 }}>
                            {treatment}
                          </Typography>
                        </Box>
                      ))}
                    </Stack>
                  </Grid>

                  {/* Prevention */}
                  <Grid item xs={12}>
                    <Typography variant="overline" color="text.secondary" fontWeight={600} sx={{ display: "block", mb: 1.5 }}>
                      How to prevent it next time
                    </Typography>
                    <Stack spacing={1.5}>
                      {result.prevention.map((tip, index) => (
                        <Box
                          key={index}
                          sx={{
                            p: 2,
                            bgcolor: "#f8f5ef",
                            borderRadius: 2,
                            border: "1px solid rgba(0,0,0,0.04)",
                            display: "flex",
                            gap: 2,
                            alignItems: "center",
                          }}
                        >
                          <Box
                            sx={{
                              width: 28,
                              height: 28,
                              bgcolor: "#c9a96e",
                              color: "#fff",
                              borderRadius: "50%",
                              display: "flex",
                              alignItems: "center",
                              justifyContent: "center",
                              fontWeight: 700,
                              fontSize: "0.8rem",
                              flexShrink: 0,
                            }}
                          >
                            {index + 1}
                          </Box>
                          <Typography variant="body2" color="text.primary" sx={{ flex: 1 }}>
                            {tip}
                          </Typography>
                        </Box>
                      ))}
                    </Stack>
                  </Grid>

                  {/* Actions */}
                  <Grid item xs={12}>
                    <Stack direction={{ xs: "column", sm: "row" }} spacing={2} sx={{ pt: 1 }}>
                      <Button
                        variant="contained"
                        size="large"
                        startIcon={<DownloadOutlined />}
                        fullWidth
                        onClick={handleDownload}
                      >
                        Download Report
                      </Button>
                      <Button
                        variant="outlined"
                        size="large"
                        startIcon={<SupportAgentOutlined />}
                        fullWidth
                      >
                        Talk to an Expert
                      </Button>
                    </Stack>
                  </Grid>
                </Grid>
              </Box>
            </Paper>
          )}
        </Stack>
      </Container>
    </Box>
  );
};

export default Results;
